allow_k8s_contexts(['orbstack', 'docker-desktop'])

load('ext://helm_remote', 'helm_remote')
load('ext://dotenv', 'dotenv')

# Check if .env exists, if not copy from .env.example
if not os.path.exists('.env'):
  local('cp .env.example .env')
  print("üìù Created .env from .env.example, be sure to fill in any necessary unique values (ex. API keys)")
else:
  print("üìù .env already exists, skipping copy from .env.example")

# PostgreSQL database for local development
# https://dev.to/flodev/use-tilt-to-provide-easy-to-setup-development-environments-4n9d
helm_remote(
  'postgresql',
  repo_url='https://charts.bitnami.com/bitnami',
  namespace='archestra-dev',
  create_namespace=True,
  set=[
    'auth.database=archestra_dev',
    'auth.username=archestra',
    'auth.password=archestra_dev_password',

    # NOTE: Bitnami is archiving their image.. see these github comments for details
    # (this is essentially why we need to override image.repository and image.tag and global.security.allowInsecureImages)
    #
    # https://github.com/coder/coder/issues/19869#issuecomment-3305875979
    # https://github.com/bitnami/containers/issues/83267
    'image.repository=bitnamisecure/postgresql',
    'image.tag=latest',
    'global.security.allowInsecureImages=true'
  ]
)

k8s_resource('postgresql', port_forwards=['5432:5432'], labels=['database'])

# Database cleanup button (manual trigger only, for development)
local_resource(
  'db-clean',
  cmd='cd backend && pnpm db:clean',
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  labels=['database']
)

dotenv(
  './.env'
)

# pre
local_resource(
  'pnpm-install',
  cmd='pnpm install',
  deps=['./frontend/package.json', './backend/package.json'],
  labels=['pre']
)

local_resource(
  'db-migrate-and-seed',
  # NOTE: we need to cd into the backend directory to run the migrate command
  # because otherwise if we run the command from this directory, it is run via turbo, which does not properly
  # propogate the required environment variables (ie. DATABASE_URL)
  # Retry logic: wait for PostgreSQL to be ready before running migrations, then seed
  cmd='''
    cd backend
    for i in {1..30}; do
      if pnpm db:migrate 2>/dev/null; then
        echo "‚úÖ Migration completed successfully"
        echo "üå± Running database seed..."
        if pnpm db:seed; then
          echo "‚úÖ Seed completed successfully"
          exit 0
        else
          echo "‚ùå Seed failed"
          exit 1
        fi
      fi
      echo "‚è≥ Waiting for PostgreSQL... (attempt $i/30)"
      sleep 2
    done
    echo "‚ùå Migration failed after 30 attempts"
    exit 1
  ''',
  deps=['./backend/src/database/migrations', './backend/src/standalone-scripts/seed-db.ts'],
  resource_deps=['pnpm-install', 'postgresql'],
  labels=['pre']
)

# dev
local_resource(
  'pnpm-dev',
  serve_cmd='pnpm dev',
  labels=['dev'],
  resource_deps=['db-migrate-and-seed']
)

local_resource(
  'database-gui',
  # NOTE: we need to cd into the backend directory to run the migrate command
  # because otherwise if we run the command from this directory, it is run via turbo, which does not properly
  # propogate the required environment variables (ie. DATABASE_URL)
  serve_cmd='cd backend && pnpm db:studio',
  labels=['dev'],
  resource_deps=['db-migrate-and-seed']
)

local_resource(
  'lint:fix',
  cmd='pnpm type-check && pnpm lint:fix',
  labels=['dev'],
  resource_deps=['pnpm-install'],
  deps=[
    "./frontend/src",
    "./backend/src",
    "./experiments/src",
    "./biome.json"
  ]
)

local_resource(
  'lint:fix:unsafe',
  cmd='pnpm lint:fix:unsafe',
  labels=['dev'],
  resource_deps=['pnpm-install'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
)

local_resource(
  'codegen:api-client',
  cmd='pnpm codegen:api-client',
  labels=['dev'],
  resource_deps=['pnpm-install', 'pnpm-dev']
)
