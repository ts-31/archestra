name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean
      is-release-please-pr:
        description: "Whether this is a release-please PR (enables auto-commit of codegen changes)"
        required: false
        type: boolean
        default: false
      is-fork-pr:
        description: "Whether this PR is from a fork (uses artifacts instead of GHCR)"
        required: false
        type: boolean
        default: false
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN:
        required: true
      TURBOREPO_REMOTE_CACHING_TEAM:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      # Required for release-please PRs to push codegen changes with a token that triggers workflow re-runs
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      # see https://stackoverflow.com/a/67551255
      ARCHESTRA_RELEASER_GITHUB_APP_ID:
        required: false
      ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY:
        required: false

jobs:
  paths-filter:
    name: Detect changed paths
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      mcp-server-base-image: ${{ steps.filter.outputs.mcp-server-base-image }}
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Filter paths
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            mcp-server-base-image:
              - 'platform/mcp_server_docker_image/**'
              - '.github/workflows/build-base-mcp-server-docker-image.yml'

  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for release-please auto-commit of codegen changes
    defaults:
      run:
        working-directory: ./platform
    env:
      TURBO_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
    steps:
      # Generate GitHub App token for release-please PRs to push codegen changes
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      - name: Generate token for release-please PR
        if: ${{ inputs.should-skip-running-and-always-succeed != true && inputs.is-release-please-pr == true }}
        id: generate-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_ID }}
          private-key: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: ${{ inputs.is-release-please-pr }} # zizmor: ignore[artipacked]
          ref: ${{ inputs.is-release-please-pr && github.head_ref || '' }}
          token: ${{ steps.generate-token.outputs.token || github.token }}

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

      # Validation checks - codegen, drizzle-kit, db migrations
      - name: Run validation checks (drizzle-kit, codegen, db migrations)
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        env:
          IS_RELEASE_PLEASE_PR: ${{ inputs.is-release-please-pr }}
        run: |
          set -e

          # Start drizzle-kit check in background
          echo "Starting drizzle-kit check in background..."
          (cd backend && pnpm drizzle-kit check) &
          DRIZZLE_PID=$!

          # Run codegen and lint
          echo "Running codegen..."
          pnpm codegen
          pnpm lint:fix

          # Check for codegen changes
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            if [ "$IS_RELEASE_PLEASE_PR" == "true" ]; then
              echo "ðŸ“¦ Release-please PR with codegen changes detected. Auto-committing..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git -C "$GITHUB_WORKSPACE" add docs/ platform/
              git commit -m "chore: update docs/openapi.json version for release"
              git push
              echo "âœ… Changes committed. Workflow will be re-triggered."
              exit 0
            else
              echo "::error::Generated code is not up to date. Please run 'pnpm codegen && pnpm lint:fix' locally and commit the changes."
              exit 1
            fi
          fi
          echo "âœ… Generated code is up to date"

          # Verify no pending database migrations
          echo "Checking for pending database migrations..."
          set +e
          if timeout 15s pnpm db:generate > /tmp/db_generate_output.txt 2>&1; then
            output=$(cat /tmp/db_generate_output.txt)
            echo "$output"
            if echo "$output" | grep -q "â¯\|Is.*table created or renamed"; then
              echo "âŒ Interactive prompt detected - pending database migrations need to be committed"
              exit 1
            fi
          else
            exit_code=$?
            cat /tmp/db_generate_output.txt 2>/dev/null || true
            if [ $exit_code -eq 124 ]; then
              echo "âŒ Command timed out - likely waiting for interactive input about pending migrations"
            else
              echo "âŒ pnpm db:generate failed with exit code $exit_code"
            fi
            exit 1
          fi
          set -e

          # Check for uncommitted migration files
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            echo "::error::Database schema has changed but migrations are missing. Run 'pnpm db:generate' locally."
            git diff --name-only
            exit 1
          fi
          echo "âœ… No pending database migrations"

          # Wait for drizzle-kit check
          echo "Waiting for drizzle-kit check..."
          if wait "$DRIZZLE_PID"; then
            echo "âœ… drizzle-kit check passed"
          else
            echo "âŒ drizzle-kit check failed"
            exit 1
          fi

          echo "âœ… All validation checks passed"

  # Build platform Docker image once for all e2e tests
  # Non-fork PRs: Push to GHCR (faster)
  # Fork PRs: Upload as artifact (no package write permissions needed)
  platform-e2e-build:
    name: Build Platform Image
    runs-on: blacksmith-16vcpu-ubuntu-2404
    if: ${{ inputs.should-skip-running-and-always-succeed != true }}
    permissions:
      contents: read
      packages: write
    outputs:
      image-source: ${{ inputs.is-fork-pr && 'artifact' || 'ghcr' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Login to GHCR
        if: ${{ !inputs.is-fork-pr }}
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Non-fork PRs: Build and push to GHCR
      - name: Build and push Docker image to GHCR
        if: ${{ !inputs.is-fork-pr }}
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          push: "true"
          tags: ghcr.io/${{ github.repository }}/platform:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      # Fork PRs: Build locally and export as artifact
      - name: Build Docker image locally
        if: ${{ inputs.is-fork-pr }}
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          push: "false"
          load: "true"
          tags: archestra-platform:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      - name: Export Docker image as tarball
        if: ${{ inputs.is-fork-pr }}
        run: |
          docker save archestra-platform:${{ github.sha }} | gzip > /tmp/platform-image.tar.gz
          ls -lh /tmp/platform-image.tar.gz

      - name: Upload Docker image artifact
        if: ${{ inputs.is-fork-pr }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: platform-docker-image
          path: /tmp/platform-image.tar.gz
          retention-days: 1
          compression-level: 0 # Already gzipped

  # E2E tests - runs all e2e test suites in parallel
  # Uses matrix strategy to run API, UI (sharded), and Vault tests concurrently
  platform-e2e-tests:
    name: Platform E2E Tests (${{ matrix.name }})
    needs: [platform-e2e-build]
    # Run even when platform-e2e-build is skipped (on PRs) so job succeeds rather than being skipped
    if: ${{ !cancelled() }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: API
            runner: blacksmith-16vcpu-ubuntu-2404
            projects: api
            shard: ""
            artifact: blob-report-api
          # UI tests - sharded across 3 parallel jobs
          - name: UI 1/3
            runner: blacksmith-16vcpu-ubuntu-2404
            projects: chromium --project=firefox --project=webkit --project=sso
            shard: "--shard=1/3"
            artifact: blob-report-ui-1
          - name: UI 2/3
            runner: blacksmith-16vcpu-ubuntu-2404
            projects: chromium --project=firefox --project=webkit --project=sso
            shard: "--shard=2/3"
            artifact: blob-report-ui-2
          - name: UI 3/3
            runner: blacksmith-16vcpu-ubuntu-2404
            projects: chromium --project=firefox --project=webkit --project=sso
            shard: "--shard=3/3"
            artifact: blob-report-ui-3
          # Vault tests - isolated to avoid race conditions with secrets manager switching
          - name: Vault
            runner: blacksmith-16vcpu-ubuntu-2404
            projects: credentials-with-vault
            shard: ""
            artifact: blob-report-vault
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      # Non-fork PRs: Pull from GHCR
      - name: Login to GHCR
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !inputs.is-fork-pr }}
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull platform image from GHCR
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !inputs.is-fork-pr }}
        run: |
          docker pull ghcr.io/${{ github.repository }}/platform:${{ github.sha }}

      # Fork PRs: Download artifact and load
      - name: Download platform image artifact
        if: ${{ inputs.should-skip-running-and-always-succeed != true && inputs.is-fork-pr }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: platform-docker-image
          path: /tmp

      - name: Load platform Docker image
        if: ${{ inputs.should-skip-running-and-always-succeed != true && inputs.is-fork-pr }}
        run: |
          gunzip -c /tmp/platform-image.tar.gz | docker load
          docker images

      - name: Setup Archestra Platform
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-archestra-platform
        with:
          kind-config-path: .github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: .github/values-ci.yaml
          deploy-e2e-dependencies: "true"
          build-platform-image: "false"
          platform-image-tag: ${{ inputs.is-fork-pr && format('archestra-platform:{0}', github.sha) || format('ghcr.io/{0}/platform:{1}', github.repository, github.sha) }}
          platform-context: ./platform

      - name: Resolve Playwright version
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          VERSION=$(cat platform/e2e-tests/package.json | jq -r '.devDependencies["@playwright/test"]' | sed 's/^[\^~]//')
          echo "PLAYWRIGHT_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Run E2E tests
        id: e2e
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform
        run: |
          set -o pipefail
          docker run --rm \
            --network host \
            --ipc=host \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work/platform \
            -e CI=true \
            -e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
            "mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION}-noble" \
            /bin/bash -c "corepack enable && corepack prepare pnpm@10.24.0 --activate && pnpm test:e2e -- --project=${{ matrix.projects }} ${{ matrix.shard }}" \
            2>&1 | tee playwright-output.txt

      - name: Check for flaky tests
        id: check-flaky
        if: success()
        run: |
          if grep -qE "[0-9]+ flaky" platform/playwright-output.txt 2>/dev/null; then
            echo "âš ï¸ Flaky tests detected"
            echo "has_flaky_tests=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload blob report
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ matrix.artifact }}
          path: platform/e2e-tests/blob-report/
          retention-days: 1

      - name: Show logs on failure or flaky tests
        if: failure() || steps.check-flaky.outputs.has_flaky_tests == 'true'
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200

          echo "=== WireMock Logs ==="
          kubectl logs -l app=e2e-tests-wiremock --tail=200 2>/dev/null || true

          echo "=== Keycloak Logs ==="
          kubectl logs -l app.kubernetes.io/name=keycloak --tail=200 2>/dev/null || true

          echo "=== Vault Logs ==="
          kubectl logs -l app.kubernetes.io/name=vault --tail=200 2>/dev/null || true

  # Merge all Playwright reports into a single HTML report
  platform-e2e-merge-reports:
    name: Merge E2E Test Reports
    needs: [platform-e2e-tests]
    if: ${{ always() && !cancelled() && inputs.should-skip-running-and-always-succeed != true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Download all blob reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: platform/e2e-tests/blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge reports
        working-directory: ./platform/e2e-tests
        env:
          PLAYWRIGHT_JSON_OUTPUT_NAME: results.json
        run: |
          echo "=== Contents of blob-reports directory ==="
          ls -la ./blob-reports/ || echo "blob-reports directory not found"
          echo "=== Merging reports ==="
          pnpm exec playwright merge-reports --reporter=html,json ./blob-reports
          echo "=== Files created after merge ==="
          ls -la
          ls -la ./playwright-report/ || echo "playwright-report directory not created"

      - name: Upload merged Playwright report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          # Shorter retention for success, full retention for failures
          retention-days: ${{ needs.platform-e2e-tests.result == 'success' && 7 || 30 }}

      - name: Write test summary
        if: always()
        uses: daun/playwright-report-summary@be9e270edd5ad86038604d3caa84a819a6ff6fed # v3.10.0
        with:
          report-file: platform/e2e-tests/results.json
          job-summary: true

  platform-docker-image-scanning:
    name: Platform Docker Image Scanning
    needs: [platform-e2e-build]
    # Run even when platform-e2e-build is skipped (on PRs) so job succeeds rather than being skipped
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      # Non-fork PRs: Pull from GHCR
      - name: Login to GHCR
        if: ${{ github.event_name == 'merge_group' && !inputs.is-fork-pr }}
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull platform image from GHCR
        if: ${{ github.event_name == 'merge_group' && !inputs.is-fork-pr }}
        run: |
          docker pull ghcr.io/${{ github.repository }}/platform:${{ github.sha }}

      # Fork PRs: Download artifact and load
      - name: Download platform image artifact
        if: ${{ github.event_name == 'merge_group' && inputs.is-fork-pr }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: platform-docker-image
          path: /tmp

      - name: Load platform Docker image
        if: ${{ github.event_name == 'merge_group' && inputs.is-fork-pr }}
        run: |
          gunzip -c /tmp/platform-image.tar.gz | docker load
          docker images

      # Scan Docker image for CVEs using Docker Scout
      # https://github.com/docker/scout-action
      #
      # Fails the CI check if any critical or high severity CVEs are found.
      # Only checks for CVEs with available fixes (ignores unfixed vulnerabilities).
      #
      # NOTE: Skipped for fork PRs because GitHub doesn't expose repository secrets
      # to workflows triggered by fork PRs. Docker Scout requires Docker Hub auth.
      - name: Docker Scout CVE Check
        if: ${{ github.event_name == 'merge_group' && !inputs.is-fork-pr }}
        uses: docker/scout-action@f8c776824083494ab0d56b8105ba2ca85c86e4de # v1.18.2
        with:
          command: cves
          image: ghcr.io/${{ github.repository }}/platform:${{ github.sha }}
          dockerhub-user: ${{ secrets.DOCKER_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_PASSWORD }}
          only-severities: critical,high
          only-fixed: true
          write-comment: false
          exit-code: true

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform/helm/archestra
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.3
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1

  # Test that the MCP server base Docker image builds successfully
  # Only runs when relevant files are changed
  mcp-server-base-image-build:
    name: MCP Server Base Image Build
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.mcp-server-base-image == 'true' }}
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    uses: ./.github/workflows/build-base-mcp-server-docker-image.yml
    with:
      push_to_gcr: false
      version: test
